import{_ as s,o as n,c as a,Q as l}from"./chunks/framework.392dd896.js";const u=JSON.parse('{"title":"","description":"","frontmatter":{},"headers":[],"relativePath":"build-your-own-integration.md","filePath":"build-your-own-integration.md"}'),p={name:"build-your-own-integration.md"},o=l(`<h2 id="build-your-own-integrations" tabindex="-1">Build Your Own Integrations <a class="header-anchor" href="#build-your-own-integrations" aria-label="Permalink to &quot;Build Your Own Integrations&quot;">​</a></h2><p>The goal of this feature is primarily for our own use to more rapidly implement integrations with other RMMs and PSA, but we have opened it up for you to create your own integrations as well.</p><h3 id="concepts" tabindex="-1">Concepts <a class="header-anchor" href="#concepts" aria-label="Permalink to &quot;Concepts&quot;">​</a></h3><p>Behind the scenes, an integration is any class that inherits from the <code>IProvider</code> interface.</p><p>We have created a new <code>Integration</code> script type with <code>New-DynamicIntegration</code> and <code>Add-DynamicIntegrationCapability</code> Cmdlets that allow you to construct your own <code>IProvider</code> and give it capabilities, all within PowerShell.</p><p>Integrations capabilities are defined in interfaces typically prefixed with <code>ISupports...</code></p><p>Let&#39;s say you want your integration to have a Client mapping UI in ImmyBot. You would implement <code>ISupportsListingClients</code> which has a <code>GetClients</code> method.</p><p>When loading your integration, the ImmyBot engine will recognize that <code>integration is ISupportsListingClients</code> and will show the Clients tab on the Integration page.</p><p><img src="https://github.com/immense/immybot-documentation/assets/31077619/67ea8b15-0ae9-44e6-b3e0-9de250b15010" alt="image"></p><h4 id="dynamic-integration-capabilities" tabindex="-1">Dynamic Integration Capabilities <a class="header-anchor" href="#dynamic-integration-capabilities" aria-label="Permalink to &quot;Dynamic Integration Capabilities&quot;">​</a></h4><ul><li>List Customers from the remote system so they can be mapped in the ImmyBot UI</li><li>List Computers/Agents (Think RMM Agent, AV agent etc) from a remote system</li><li>Provide an inventory script that returns the agent id (that gets mapped to the id from the API)</li><li>Provide Tenant level install tokens automatically scoped based on the Customer mapping above</li><li>Disable/Enable Maintenance Mode/Learning Mode in remote systems during maintenance</li><li>Respond to HttpRequests in PowerShell (like an Azure PowerShell function) but utilizing the Metascript engine</li></ul><hr><h3 id="basic-implementation" tabindex="-1"><strong>Basic Implementation</strong> <a class="header-anchor" href="#basic-implementation" aria-label="Permalink to &quot;**Basic Implementation**&quot;">​</a></h3><div class="language-powershell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">powershell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#79B8FF;">New-DynamicIntegration</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">Init {</span></span>
<span class="line"><span style="color:#E1E4E8;">    [</span><span style="color:#F97583;">OpResult</span><span style="color:#E1E4E8;">]::Ok()</span></span>
<span class="line"><span style="color:#E1E4E8;">} </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">HealthCheck {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">New-HealthyResult</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#005CC5;">New-DynamicIntegration</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">Init {</span></span>
<span class="line"><span style="color:#24292E;">    [</span><span style="color:#D73A49;">OpResult</span><span style="color:#24292E;">]::Ok()</span></span>
<span class="line"><span style="color:#24292E;">} </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">HealthCheck {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">New-HealthyResult</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><hr><h3 id="initialization-with-parameters" tabindex="-1"><strong>Initialization with Parameters</strong> <a class="header-anchor" href="#initialization-with-parameters" aria-label="Permalink to &quot;**Initialization with Parameters**&quot;">​</a></h3><div class="language-powershell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">powershell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">$Integration </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">New-DynamicIntegration</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">Init {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">param</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#E1E4E8;">        [</span><span style="color:#79B8FF;">Parameter</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">Mandatory</span><span style="color:#E1E4E8;">)]</span></span>
<span class="line"><span style="color:#E1E4E8;">        [</span><span style="color:#F97583;">Uri</span><span style="color:#E1E4E8;">]$S1Uri</span><span style="color:#F97583;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        [</span><span style="color:#79B8FF;">Parameter</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">Mandatory</span><span style="color:#E1E4E8;">)]</span></span>
<span class="line"><span style="color:#E1E4E8;">        [</span><span style="color:#F97583;">Password</span><span style="color:#E1E4E8;">(StripValue </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">$true</span><span style="color:#E1E4E8;">)]</span></span>
<span class="line"><span style="color:#E1E4E8;">        $S1ApiKey</span></span>
<span class="line"><span style="color:#E1E4E8;">    )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    [</span><span style="color:#F97583;">OpResult</span><span style="color:#E1E4E8;">]::Ok()</span></span>
<span class="line"><span style="color:#E1E4E8;">} </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">HealthCheck {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">New-HealthyResult</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">$Integration </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">New-DynamicIntegration</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">Init {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">param</span><span style="color:#24292E;">(</span></span>
<span class="line"><span style="color:#24292E;">        [</span><span style="color:#005CC5;">Parameter</span><span style="color:#24292E;">(</span><span style="color:#E36209;">Mandatory</span><span style="color:#24292E;">)]</span></span>
<span class="line"><span style="color:#24292E;">        [</span><span style="color:#D73A49;">Uri</span><span style="color:#24292E;">]$S1Uri</span><span style="color:#D73A49;">,</span></span>
<span class="line"><span style="color:#24292E;">        [</span><span style="color:#005CC5;">Parameter</span><span style="color:#24292E;">(</span><span style="color:#E36209;">Mandatory</span><span style="color:#24292E;">)]</span></span>
<span class="line"><span style="color:#24292E;">        [</span><span style="color:#D73A49;">Password</span><span style="color:#24292E;">(StripValue </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">$true</span><span style="color:#24292E;">)]</span></span>
<span class="line"><span style="color:#24292E;">        $S1ApiKey</span></span>
<span class="line"><span style="color:#24292E;">    )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    [</span><span style="color:#D73A49;">OpResult</span><span style="color:#24292E;">]::Ok()</span></span>
<span class="line"><span style="color:#24292E;">} </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">HealthCheck {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">New-HealthyResult</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p><img src="https://github.com/immense/immybot-documentation/assets/1424395/4f8ba329-f57f-4504-875d-c6ee3a53816c" alt="image"></p><hr><h3 id="initialization-with-parameters-integrationcontext" tabindex="-1"><strong>Initialization with Parameters &amp; <code>$IntegrationContext</code></strong> <a class="header-anchor" href="#initialization-with-parameters-integrationcontext" aria-label="Permalink to &quot;**Initialization with Parameters &amp; \`$IntegrationContext\`**&quot;">​</a></h3><p>Building on the previous example, the integration parameters are stored in the <code>$IntegrationContext</code>:</p><div class="language-powershell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">powershell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">$Integration </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">New-DynamicIntegration</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">Init {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">param</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#E1E4E8;">        [</span><span style="color:#79B8FF;">Parameter</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">Mandatory</span><span style="color:#E1E4E8;">)]</span></span>
<span class="line"><span style="color:#E1E4E8;">        [</span><span style="color:#F97583;">Uri</span><span style="color:#E1E4E8;">]$S1Uri</span><span style="color:#F97583;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        [</span><span style="color:#79B8FF;">Parameter</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">Mandatory</span><span style="color:#E1E4E8;">)]</span></span>
<span class="line"><span style="color:#E1E4E8;">        [</span><span style="color:#F97583;">Password</span><span style="color:#E1E4E8;">(StripValue </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">$true</span><span style="color:#E1E4E8;">)]</span></span>
<span class="line"><span style="color:#E1E4E8;">        $S1ApiKey</span></span>
<span class="line"><span style="color:#E1E4E8;">    )</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#E1E4E8;">    $IntegrationContext.S1Uri </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> $S1Uri</span></span>
<span class="line"><span style="color:#E1E4E8;">    $IntegrationContext.S1ApiKey </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> $S1ApiKey</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    [</span><span style="color:#F97583;">OpResult</span><span style="color:#E1E4E8;">]::Ok()</span></span>
<span class="line"><span style="color:#E1E4E8;">} </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">HealthCheck {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">New-HealthyResult</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">$Integration </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">New-DynamicIntegration</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">Init {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">param</span><span style="color:#24292E;">(</span></span>
<span class="line"><span style="color:#24292E;">        [</span><span style="color:#005CC5;">Parameter</span><span style="color:#24292E;">(</span><span style="color:#E36209;">Mandatory</span><span style="color:#24292E;">)]</span></span>
<span class="line"><span style="color:#24292E;">        [</span><span style="color:#D73A49;">Uri</span><span style="color:#24292E;">]$S1Uri</span><span style="color:#D73A49;">,</span></span>
<span class="line"><span style="color:#24292E;">        [</span><span style="color:#005CC5;">Parameter</span><span style="color:#24292E;">(</span><span style="color:#E36209;">Mandatory</span><span style="color:#24292E;">)]</span></span>
<span class="line"><span style="color:#24292E;">        [</span><span style="color:#D73A49;">Password</span><span style="color:#24292E;">(StripValue </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">$true</span><span style="color:#24292E;">)]</span></span>
<span class="line"><span style="color:#24292E;">        $S1ApiKey</span></span>
<span class="line"><span style="color:#24292E;">    )</span></span>
<span class="line"><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#24292E;">    $IntegrationContext.S1Uri </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> $S1Uri</span></span>
<span class="line"><span style="color:#24292E;">    $IntegrationContext.S1ApiKey </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> $S1ApiKey</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    [</span><span style="color:#D73A49;">OpResult</span><span style="color:#24292E;">]::Ok()</span></span>
<span class="line"><span style="color:#24292E;">} </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">HealthCheck {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">New-HealthyResult</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><hr><h3 id="adding-isupportslistingclients" tabindex="-1"><strong>Adding <code>ISupportsListingClients</code></strong> <a class="header-anchor" href="#adding-isupportslistingclients" aria-label="Permalink to &quot;**Adding \`ISupportsListingClients\`**&quot;">​</a></h3><div class="language-powershell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">powershell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">$Integration </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">New-DynamicIntegration</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">Init {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">param</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#E1E4E8;">        [</span><span style="color:#79B8FF;">Parameter</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">Mandatory</span><span style="color:#E1E4E8;">)]</span></span>
<span class="line"><span style="color:#E1E4E8;">        [</span><span style="color:#F97583;">Uri</span><span style="color:#E1E4E8;">]$S1Uri</span><span style="color:#F97583;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        [</span><span style="color:#79B8FF;">Parameter</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">Mandatory</span><span style="color:#E1E4E8;">)]</span></span>
<span class="line"><span style="color:#E1E4E8;">        [</span><span style="color:#F97583;">Password</span><span style="color:#E1E4E8;">(StripValue </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">$true</span><span style="color:#E1E4E8;">)]</span></span>
<span class="line"><span style="color:#E1E4E8;">        $S1ApiKey</span></span>
<span class="line"><span style="color:#E1E4E8;">    )</span></span>
<span class="line"><span style="color:#E1E4E8;">} </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">HealthCheck {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">New-HealthyResult</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">$Integration </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">Add-DynamicIntegrationCapability</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">Interface ISupportsListingClients </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">GetClients {</span></span>
<span class="line"><span style="color:#E1E4E8;">    [</span><span style="color:#79B8FF;">CmdletBinding</span><span style="color:#E1E4E8;">()]</span></span>
<span class="line"><span style="color:#E1E4E8;">    [</span><span style="color:#79B8FF;">OutputType</span><span style="color:#E1E4E8;">([</span><span style="color:#F97583;">Immybot.Backend.Domain.Providers.IProviderClientDetails</span><span style="color:#E1E4E8;">[]])]</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">param</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># Implement logic to get clients directly in this script</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># Mockup code for example purposes</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">@</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;Client1&quot;</span><span style="color:#F97583;">,</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;Client2&quot;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ForEach-Object</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">New-IntegrationClient</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">ClientId </span><span style="color:#79B8FF;">$_</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">ClientName </span><span style="color:#79B8FF;">$_</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">$Integration </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">New-DynamicIntegration</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">Init {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">param</span><span style="color:#24292E;">(</span></span>
<span class="line"><span style="color:#24292E;">        [</span><span style="color:#005CC5;">Parameter</span><span style="color:#24292E;">(</span><span style="color:#E36209;">Mandatory</span><span style="color:#24292E;">)]</span></span>
<span class="line"><span style="color:#24292E;">        [</span><span style="color:#D73A49;">Uri</span><span style="color:#24292E;">]$S1Uri</span><span style="color:#D73A49;">,</span></span>
<span class="line"><span style="color:#24292E;">        [</span><span style="color:#005CC5;">Parameter</span><span style="color:#24292E;">(</span><span style="color:#E36209;">Mandatory</span><span style="color:#24292E;">)]</span></span>
<span class="line"><span style="color:#24292E;">        [</span><span style="color:#D73A49;">Password</span><span style="color:#24292E;">(StripValue </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">$true</span><span style="color:#24292E;">)]</span></span>
<span class="line"><span style="color:#24292E;">        $S1ApiKey</span></span>
<span class="line"><span style="color:#24292E;">    )</span></span>
<span class="line"><span style="color:#24292E;">} </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">HealthCheck {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">New-HealthyResult</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">$Integration </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">Add-DynamicIntegrationCapability</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">Interface ISupportsListingClients </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">GetClients {</span></span>
<span class="line"><span style="color:#24292E;">    [</span><span style="color:#005CC5;">CmdletBinding</span><span style="color:#24292E;">()]</span></span>
<span class="line"><span style="color:#24292E;">    [</span><span style="color:#005CC5;">OutputType</span><span style="color:#24292E;">([</span><span style="color:#D73A49;">Immybot.Backend.Domain.Providers.IProviderClientDetails</span><span style="color:#24292E;">[]])]</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">param</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># Implement logic to get clients directly in this script</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># Mockup code for example purposes</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">@</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;Client1&quot;</span><span style="color:#D73A49;">,</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;Client2&quot;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ForEach-Object</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">New-IntegrationClient</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">ClientId </span><span style="color:#005CC5;">$_</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">ClientName </span><span style="color:#005CC5;">$_</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><hr><h3 id="adding-isupportslistingagents" tabindex="-1"><strong>Adding <code>ISupportsListingAgents</code></strong> <a class="header-anchor" href="#adding-isupportslistingagents" aria-label="Permalink to &quot;**Adding \`ISupportsListingAgents\`**&quot;">​</a></h3><div class="language-powershell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">powershell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">$Integration </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">New-DynamicIntegration</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">Init {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># ... *same as above* ...</span></span>
<span class="line"><span style="color:#E1E4E8;">} </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">HealthCheck {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">New-HealthyResult</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"><span style="color:#E1E4E8;">$Integration </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">Add-DynamicIntegrationCapability</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">Interface ISupportsListingClients </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">GetClients {</span></span>
<span class="line"><span style="color:#E1E4E8;">    [</span><span style="color:#79B8FF;">CmdletBinding</span><span style="color:#E1E4E8;">()]</span></span>
<span class="line"><span style="color:#E1E4E8;">    [</span><span style="color:#79B8FF;">OutputType</span><span style="color:#E1E4E8;">([</span><span style="color:#F97583;">Immybot.Backend.Domain.Providers.IProviderClientDetails</span><span style="color:#E1E4E8;">[]])]</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">param</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># Implement logic to get clients directly in this script</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># Mockup code for example purposes</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">@</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;Client1&quot;</span><span style="color:#F97583;">,</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;Client2&quot;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ForEach-Object</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">New-IntegrationClient</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">ClientId </span><span style="color:#79B8FF;">$_</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">ClientName </span><span style="color:#79B8FF;">$_</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">$Integration </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">Add-DynamicIntegrationCapability</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">Interface ISupportsListingAgents </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">GetAgents {</span></span>
<span class="line"><span style="color:#E1E4E8;">    [</span><span style="color:#79B8FF;">CmdletBinding</span><span style="color:#E1E4E8;">()]</span></span>
<span class="line"><span style="color:#E1E4E8;">    [</span><span style="color:#79B8FF;">OutputType</span><span style="color:#E1E4E8;">([</span><span style="color:#F97583;">Immybot.Backend.Domain.Providers.IProviderAgentDetails</span><span style="color:#E1E4E8;">[]])]</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">param</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#E1E4E8;">        [</span><span style="color:#79B8FF;">Parameter</span><span style="color:#E1E4E8;">()]</span></span>
<span class="line"><span style="color:#E1E4E8;">        [</span><span style="color:#F97583;">string</span><span style="color:#E1E4E8;">[]]$ClientIds </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">$null</span></span>
<span class="line"><span style="color:#E1E4E8;">    )</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># Implement logic to get agents directly in this script</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># Mockup code for example purposes</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">@</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;Agent1&quot;</span><span style="color:#F97583;">,</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;Agent2&quot;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ForEach-Object</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">New-IntegrationAgent</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">AgentId </span><span style="color:#79B8FF;">$_</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">Name </span><span style="color:#79B8FF;">$_</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">$Integration </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">New-DynamicIntegration</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">Init {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># ... *same as above* ...</span></span>
<span class="line"><span style="color:#24292E;">} </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">HealthCheck {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">New-HealthyResult</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"><span style="color:#24292E;">$Integration </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">Add-DynamicIntegrationCapability</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">Interface ISupportsListingClients </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">GetClients {</span></span>
<span class="line"><span style="color:#24292E;">    [</span><span style="color:#005CC5;">CmdletBinding</span><span style="color:#24292E;">()]</span></span>
<span class="line"><span style="color:#24292E;">    [</span><span style="color:#005CC5;">OutputType</span><span style="color:#24292E;">([</span><span style="color:#D73A49;">Immybot.Backend.Domain.Providers.IProviderClientDetails</span><span style="color:#24292E;">[]])]</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">param</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># Implement logic to get clients directly in this script</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># Mockup code for example purposes</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">@</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;Client1&quot;</span><span style="color:#D73A49;">,</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;Client2&quot;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ForEach-Object</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">New-IntegrationClient</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">ClientId </span><span style="color:#005CC5;">$_</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">ClientName </span><span style="color:#005CC5;">$_</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">$Integration </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">Add-DynamicIntegrationCapability</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">Interface ISupportsListingAgents </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">GetAgents {</span></span>
<span class="line"><span style="color:#24292E;">    [</span><span style="color:#005CC5;">CmdletBinding</span><span style="color:#24292E;">()]</span></span>
<span class="line"><span style="color:#24292E;">    [</span><span style="color:#005CC5;">OutputType</span><span style="color:#24292E;">([</span><span style="color:#D73A49;">Immybot.Backend.Domain.Providers.IProviderAgentDetails</span><span style="color:#24292E;">[]])]</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">param</span><span style="color:#24292E;">(</span></span>
<span class="line"><span style="color:#24292E;">        [</span><span style="color:#005CC5;">Parameter</span><span style="color:#24292E;">()]</span></span>
<span class="line"><span style="color:#24292E;">        [</span><span style="color:#D73A49;">string</span><span style="color:#24292E;">[]]$ClientIds </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">$null</span></span>
<span class="line"><span style="color:#24292E;">    )</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># Implement logic to get agents directly in this script</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># Mockup code for example purposes</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">@</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;Agent1&quot;</span><span style="color:#D73A49;">,</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;Agent2&quot;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ForEach-Object</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">New-IntegrationAgent</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">AgentId </span><span style="color:#005CC5;">$_</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">Name </span><span style="color:#005CC5;">$_</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><hr><h3 id="move-duplicate-code-to-a-module" tabindex="-1"><strong>Move duplicate code to a Module</strong> <a class="header-anchor" href="#move-duplicate-code-to-a-module" aria-label="Permalink to &quot;**Move duplicate code to a Module**&quot;">​</a></h3><div class="language-powershell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">powershell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">$Integration </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">New-DynamicIntegration</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">Init {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">param</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#E1E4E8;">        [</span><span style="color:#79B8FF;">Parameter</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">Mandatory</span><span style="color:#E1E4E8;">)]</span></span>
<span class="line"><span style="color:#E1E4E8;">        [</span><span style="color:#F97583;">Uri</span><span style="color:#E1E4E8;">]$S1Uri</span><span style="color:#F97583;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        [</span><span style="color:#79B8FF;">Parameter</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">Mandatory</span><span style="color:#E1E4E8;">)]</span></span>
<span class="line"><span style="color:#E1E4E8;">        [</span><span style="color:#F97583;">Password</span><span style="color:#E1E4E8;">(StripValue </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">$true</span><span style="color:#E1E4E8;">)]</span></span>
<span class="line"><span style="color:#E1E4E8;">        $S1ApiKey</span></span>
<span class="line"><span style="color:#E1E4E8;">    )</span></span>
<span class="line"><span style="color:#E1E4E8;">} </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">HealthCheck {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">New-HealthyResult</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">$Integration </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">Add-DynamicIntegrationCapability</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">Interface ISupportsListingClients </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">GetClients {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">Import-Module</span><span style="color:#E1E4E8;"> SentinelOne</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">Get-S1Site</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ForEach-Object</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">New-IntegrationClient</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">ClientId </span><span style="color:#79B8FF;">$_</span><span style="color:#E1E4E8;">.Id </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">ClientName </span><span style="color:#79B8FF;">$_</span><span style="color:#E1E4E8;">.Name</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">$Integration </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">Add-DynamicIntegrationCapability</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">Interface ISupportsListingAgents </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">GetAgents {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">Import-Module</span><span style="color:#E1E4E8;"> SentinelOne</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">Get-S1Agent</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ForEach-Object</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">New-IntegrationAgent</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">AgentId </span><span style="color:#79B8FF;">$_</span><span style="color:#E1E4E8;">.Id </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">Name </span><span style="color:#79B8FF;">$_</span><span style="color:#E1E4E8;">.Name</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">$Integration </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">New-DynamicIntegration</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">Init {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">param</span><span style="color:#24292E;">(</span></span>
<span class="line"><span style="color:#24292E;">        [</span><span style="color:#005CC5;">Parameter</span><span style="color:#24292E;">(</span><span style="color:#E36209;">Mandatory</span><span style="color:#24292E;">)]</span></span>
<span class="line"><span style="color:#24292E;">        [</span><span style="color:#D73A49;">Uri</span><span style="color:#24292E;">]$S1Uri</span><span style="color:#D73A49;">,</span></span>
<span class="line"><span style="color:#24292E;">        [</span><span style="color:#005CC5;">Parameter</span><span style="color:#24292E;">(</span><span style="color:#E36209;">Mandatory</span><span style="color:#24292E;">)]</span></span>
<span class="line"><span style="color:#24292E;">        [</span><span style="color:#D73A49;">Password</span><span style="color:#24292E;">(StripValue </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">$true</span><span style="color:#24292E;">)]</span></span>
<span class="line"><span style="color:#24292E;">        $S1ApiKey</span></span>
<span class="line"><span style="color:#24292E;">    )</span></span>
<span class="line"><span style="color:#24292E;">} </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">HealthCheck {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">New-HealthyResult</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">$Integration </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">Add-DynamicIntegrationCapability</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">Interface ISupportsListingClients </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">GetClients {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">Import-Module</span><span style="color:#24292E;"> SentinelOne</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">Get-S1Site</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ForEach-Object</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">New-IntegrationClient</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">ClientId </span><span style="color:#005CC5;">$_</span><span style="color:#24292E;">.Id </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">ClientName </span><span style="color:#005CC5;">$_</span><span style="color:#24292E;">.Name</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">$Integration </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">Add-DynamicIntegrationCapability</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">Interface ISupportsListingAgents </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">GetAgents {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">Import-Module</span><span style="color:#24292E;"> SentinelOne</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">Get-S1Agent</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ForEach-Object</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">New-IntegrationAgent</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">AgentId </span><span style="color:#005CC5;">$_</span><span style="color:#24292E;">.Id </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">Name </span><span style="color:#005CC5;">$_</span><span style="color:#24292E;">.Name</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><hr><h4 id="integration-context" tabindex="-1">Integration Context <a class="header-anchor" href="#integration-context" aria-label="Permalink to &quot;Integration Context&quot;">​</a></h4><p><code>$IntegrationContext</code> is a Hashtable used to share data between the ScriptBlocks <em>within the integration only</em>.</p><p>By design, the data in <code>$IntegrationContext</code> is where you put sensitive data like Access Tokens.</p><p>It is not available in scripts outside of the integration as this could expose those tokens via the Debugger.</p><p>Instead, we provide the following Cmdlets to access integration data from the Metascript context:</p><ul><li>Get-IntegrationAgentInstallToken</li><li>Get-IntegrationTenantUninstallTokenCmdlet</li><li>Get-IntegrationAgentUninstallTokenCmdlet</li></ul><p>These Cmdlets do not require any parameters as everything they need is available in the Action&#39;s context.</p><p>Let&#39;s say you create an integration that has an agent that requires an install token.</p><p>You would create a piece of Software and link it to that Integration Type, essentially saying &quot;This software is the agent for SentinelOne&quot;.</p><p>When you create a Deployment for that Software, if there are multiple integrations of that type, you will be required to select one. (Maybe you are migrating SentinelOne from one server to another)</p><p>That Deployment will create an Action on the session linked back to that Deployment, that is linked to that specific SentinelOne instance.</p><p>When you call Get-IntegrationAgentInstallToken from within the SentinelOne install script, the backend calls GetTenantInstallToken(string clientId) on the SentinelOne integration provided by the Deployment. ClientId is provided automatically by looking up the Computer&#39;s ImmyBot tenantId in the integration&#39;s Client mapping.</p><p><img src="https://github.com/immense/immybot-documentation/assets/31077619/ebdbfab0-a149-4d0d-8e56-cad8291df879" alt="image"></p><p><img src="https://github.com/immense/immybot-documentation/assets/31077619/f5a9d865-2a7d-4843-9a58-298557dd674d" alt="image"></p><h3 id="example-sentinelone" tabindex="-1">Example: SentinelOne <a class="header-anchor" href="#example-sentinelone" aria-label="Permalink to &quot;Example: SentinelOne&quot;">​</a></h3><div class="language-powershell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">powershell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">$Integration </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">New-DynamicIntegration</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">Init {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># These parameters generate the form on the New/Edit Integration page</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">param</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#E1E4E8;">        [</span><span style="color:#79B8FF;">Parameter</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">Mandatory</span><span style="color:#E1E4E8;">)]</span></span>
<span class="line"><span style="color:#E1E4E8;">        [</span><span style="color:#F97583;">Uri</span><span style="color:#E1E4E8;">]$S1Uri</span><span style="color:#F97583;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        [</span><span style="color:#79B8FF;">Parameter</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">Mandatory</span><span style="color:#E1E4E8;">)]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;"># [DisplayName(&quot;API Key&quot;)]</span></span>
<span class="line"><span style="color:#E1E4E8;">        [</span><span style="color:#F97583;">Password</span><span style="color:#E1E4E8;">(StripValue </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">$true</span><span style="color:#E1E4E8;">)]</span></span>
<span class="line"><span style="color:#E1E4E8;">        $S1ApiKey</span></span>
<span class="line"><span style="color:#E1E4E8;">    )</span></span>
<span class="line"><span style="color:#E1E4E8;">    $providerTypeFormData </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">Write-Variable</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># Note: The SentinelOne module is a Module script in Global </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">Import-Module</span><span style="color:#E1E4E8;"> SentinelOne    </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">Get-Command</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">Module SentinelOne </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">Out-String</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">Write-Host</span></span>
<span class="line"><span style="color:#E1E4E8;">    $S1AuthHeader </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">Connect-S1API</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">S1Uri $S1Uri </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">S1APIToken $S1ApiKey</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># The SentinelOne module in Global will automatically use the following $IntegrationContext values if present</span></span>
<span class="line"><span style="color:#E1E4E8;">    $IntegrationContext.S1Uri </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> $S1Uri</span></span>
<span class="line"><span style="color:#E1E4E8;">    $IntegrationContext.S1ApiKey </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> $S1ApiKey</span></span>
<span class="line"><span style="color:#E1E4E8;">    $IntegrationContext.AuthHeader </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> $S1AuthHeader</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#E1E4E8;">    [</span><span style="color:#F97583;">OpResult</span><span style="color:#E1E4E8;">]::Ok()</span></span>
<span class="line"><span style="color:#E1E4E8;">} </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">HealthCheck {</span></span>
<span class="line"><span style="color:#E1E4E8;">    [</span><span style="color:#79B8FF;">CmdletBinding</span><span style="color:#E1E4E8;">()]</span></span>
<span class="line"><span style="color:#E1E4E8;">    [</span><span style="color:#79B8FF;">OutputType</span><span style="color:#E1E4E8;">([</span><span style="color:#F97583;">HealthCheckResult</span><span style="color:#E1E4E8;">])]</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">param</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span></span>
<span class="line"><span style="color:#E1E4E8;">    )</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># todo: implement health check</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">New-HealthyResult</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># ISupportsListingClients will create a Clients tab on the Integration for mapping ImmyBot tenants to the Clients returned by this script</span></span>
<span class="line"><span style="color:#E1E4E8;">$Integration </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">Add-DynamicIntegrationCapability</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">Interface ISupportsListingClients </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">GetClients {</span></span>
<span class="line"><span style="color:#E1E4E8;">    [</span><span style="color:#79B8FF;">CmdletBinding</span><span style="color:#E1E4E8;">()]</span></span>
<span class="line"><span style="color:#E1E4E8;">    [</span><span style="color:#79B8FF;">OutputType</span><span style="color:#E1E4E8;">([</span><span style="color:#F97583;">Immybot.Backend.Domain.Providers.IProviderClientDetails</span><span style="color:#E1E4E8;">[]])]</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">param</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># return a list of clients for this integration using the New-IntegrationClient cmdlet</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">Import-Module</span><span style="color:#E1E4E8;"> SentinelOne</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">Get-S1Site</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">Verbose </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ForEach-Object</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">New-IntegrationClient</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">ClientId </span><span style="color:#79B8FF;">$_</span><span style="color:#E1E4E8;">.Id </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">ClientName </span><span style="color:#79B8FF;">$_</span><span style="color:#E1E4E8;">.Name</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># supports listing agents</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">$Integration </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">Add-DynamicIntegrationCapability</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">Interface ISupportsListingAgents </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">GetAgents {</span></span>
<span class="line"><span style="color:#E1E4E8;">    [</span><span style="color:#79B8FF;">CmdletBinding</span><span style="color:#E1E4E8;">()]</span></span>
<span class="line"><span style="color:#E1E4E8;">    [</span><span style="color:#79B8FF;">OutputType</span><span style="color:#E1E4E8;">([</span><span style="color:#F97583;">Immybot.Backend.Domain.Providers.IProviderAgentDetails</span><span style="color:#E1E4E8;">[]])]</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">param</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#E1E4E8;">        [</span><span style="color:#79B8FF;">Parameter</span><span style="color:#E1E4E8;">()]</span></span>
<span class="line"><span style="color:#E1E4E8;">        [</span><span style="color:#F97583;">string</span><span style="color:#E1E4E8;">[]]$ClientIds </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">$null</span></span>
<span class="line"><span style="color:#E1E4E8;">    )</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># ClientIds will contain the clientids you mapped to ImmyBot tenants under the Integration-&gt;Clients tab</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># The agents you return here will go into the Computers-&gt;Pending Identification area until they are linked to Computers via the AgentId provided by ISupportsInventoryIdentification</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">Import-Module</span><span style="color:#E1E4E8;"> SentinelOne</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">foreach</span><span style="color:#E1E4E8;">($ClientId </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> $ClientIds)</span></span>
<span class="line"><span style="color:#E1E4E8;">    {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">Get-S1Agent</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">SiteId $ClientId </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">Verbose </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ForEach-Object</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">New-IntegrationAgent</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">AgentId </span><span style="color:#79B8FF;">$_</span><span style="color:#E1E4E8;">.uuid </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">Name </span><span style="color:#79B8FF;">$_</span><span style="color:#E1E4E8;">.computerName </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">SerialNumber </span><span style="color:#79B8FF;">$_</span><span style="color:#E1E4E8;">.serialNumber </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">OSName </span><span style="color:#79B8FF;">$_</span><span style="color:#E1E4E8;">.osName </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">Manufacturer </span><span style="color:#79B8FF;">$_</span><span style="color:#E1E4E8;">.modelName </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">ClientId </span><span style="color:#79B8FF;">$_</span><span style="color:#E1E4E8;">.siteId </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">IsOnline </span><span style="color:#79B8FF;">$true</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">AgentVersion </span><span style="color:#79B8FF;">$_</span><span style="color:#E1E4E8;">.agentVersion </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">SupportsRunningScripts </span><span style="color:#79B8FF;">$false</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># supports inventory identification</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">$Integration </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">Add-DynamicIntegrationCapability</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">Interface ISupportsInventoryIdentification </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">GetInventoryScript {</span></span>
<span class="line"><span style="color:#E1E4E8;">    [</span><span style="color:#79B8FF;">CmdletBinding</span><span style="color:#E1E4E8;">()]</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">param</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># This ScriptBlock will be run in the Metascript context for every machine during initial identification and daily inventory</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">Invoke-ImmyCommand</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;"># Return the SentinelOne AgentId</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;"># We will match it to New-IntegrationAgent -AgentId you returned in ISupportsListingAgents</span></span>
<span class="line"><span style="color:#E1E4E8;">        $path </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">Resolve-Path</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">&quot;C:\\Program Files\\SentinelOne\\Sentinel Agent*\\SentinelCtl.exe&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;">($path)</span></span>
<span class="line"><span style="color:#E1E4E8;">        {</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">.</span><span style="color:#E1E4E8;"> $path.Path agent_id</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># supports retrieving a tenant install token</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">$Integration </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">Add-DynamicIntegrationCapability</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">Interface ISupportsTenantInstallToken </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">GetTenantInstallToken {</span></span>
<span class="line"><span style="color:#E1E4E8;">    [</span><span style="color:#79B8FF;">CmdletBinding</span><span style="color:#E1E4E8;">()]</span></span>
<span class="line"><span style="color:#E1E4E8;">    [</span><span style="color:#79B8FF;">OutputType</span><span style="color:#E1E4E8;">([</span><span style="color:#F97583;">System.String</span><span style="color:#E1E4E8;">])]</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">param</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#E1E4E8;">        [</span><span style="color:#79B8FF;">Parameter</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">Mandatory</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">$true</span><span style="color:#E1E4E8;">)]</span></span>
<span class="line"><span style="color:#E1E4E8;">        [</span><span style="color:#F97583;">string</span><span style="color:#E1E4E8;">]$clientId</span></span>
<span class="line"><span style="color:#E1E4E8;">    )</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">Get-S1Site</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">Id $clientId </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">%</span><span style="color:#E1E4E8;">{ </span><span style="color:#79B8FF;">$_</span><span style="color:#E1E4E8;">.registrationToken}</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># supports retrieving a tenant uninstall token</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">$Integration </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">Add-DynamicIntegrationCapability</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">Interface ISupportsTenantUninstallToken </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">GetTenantUninstallToken {</span></span>
<span class="line"><span style="color:#E1E4E8;">    [</span><span style="color:#79B8FF;">CmdletBinding</span><span style="color:#E1E4E8;">()]</span></span>
<span class="line"><span style="color:#E1E4E8;">    [</span><span style="color:#79B8FF;">OutputType</span><span style="color:#E1E4E8;">([</span><span style="color:#F97583;">System.String</span><span style="color:#E1E4E8;">])]</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">param</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#E1E4E8;">        [</span><span style="color:#79B8FF;">Parameter</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">Mandatory</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">$true</span><span style="color:#E1E4E8;">)]</span></span>
<span class="line"><span style="color:#E1E4E8;">        [</span><span style="color:#F97583;">System.String</span><span style="color:#E1E4E8;">]$clientId</span></span>
<span class="line"><span style="color:#E1E4E8;">    )</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;implement me&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">$Integration </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">Add-DynamicIntegrationCapability</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">Interface ISupportsHttpRequest </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">HandleHttpRequest {</span></span>
<span class="line"><span style="color:#E1E4E8;">    [</span><span style="color:#79B8FF;">CmdletBinding</span><span style="color:#E1E4E8;">()]</span></span>
<span class="line"><span style="color:#E1E4E8;">    [</span><span style="color:#79B8FF;">OutputType</span><span style="color:#E1E4E8;">([</span><span style="color:#F97583;">Microsoft.AspNetCore.Mvc.IActionResult</span><span style="color:#E1E4E8;">])]</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">param</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#E1E4E8;">        [</span><span style="color:#79B8FF;">Parameter</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">Mandatory</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">$True</span><span style="color:#E1E4E8;">)]</span></span>
<span class="line"><span style="color:#E1E4E8;">        [</span><span style="color:#F97583;">Microsoft.AspNetCore.Http.HttpContext</span><span style="color:#E1E4E8;">]$httpContext</span><span style="color:#F97583;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        [</span><span style="color:#79B8FF;">Parameter</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">Mandatory</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">$false</span><span style="color:#E1E4E8;">)]</span></span>
<span class="line"><span style="color:#E1E4E8;">        $body</span><span style="color:#F97583;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        [</span><span style="color:#79B8FF;">Parameter</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">Mandatory</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">$True</span><span style="color:#E1E4E8;">)]</span></span>
<span class="line"><span style="color:#E1E4E8;">        $route</span></span>
<span class="line"><span style="color:#E1E4E8;">    )</span></span>
<span class="line"><span style="color:#E1E4E8;">will response to  </span><span style="color:#9ECBFF;">&quot;plugins/api/v1/{providerLinkId}&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># handle a http request sent to this integration</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># return an [ObjectResult] and set the status code</span></span>
<span class="line"><span style="color:#E1E4E8;">    $res </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> [</span><span style="color:#F97583;">ObjectResult</span><span style="color:#E1E4E8;">]::new(</span><span style="color:#9ECBFF;">&#39;ok&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    $res.StatusCode </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">200</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> $res;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> $Integration</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">$Integration </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">New-DynamicIntegration</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">Init {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># These parameters generate the form on the New/Edit Integration page</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">param</span><span style="color:#24292E;">(</span></span>
<span class="line"><span style="color:#24292E;">        [</span><span style="color:#005CC5;">Parameter</span><span style="color:#24292E;">(</span><span style="color:#E36209;">Mandatory</span><span style="color:#24292E;">)]</span></span>
<span class="line"><span style="color:#24292E;">        [</span><span style="color:#D73A49;">Uri</span><span style="color:#24292E;">]$S1Uri</span><span style="color:#D73A49;">,</span></span>
<span class="line"><span style="color:#24292E;">        [</span><span style="color:#005CC5;">Parameter</span><span style="color:#24292E;">(</span><span style="color:#E36209;">Mandatory</span><span style="color:#24292E;">)]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;"># [DisplayName(&quot;API Key&quot;)]</span></span>
<span class="line"><span style="color:#24292E;">        [</span><span style="color:#D73A49;">Password</span><span style="color:#24292E;">(StripValue </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">$true</span><span style="color:#24292E;">)]</span></span>
<span class="line"><span style="color:#24292E;">        $S1ApiKey</span></span>
<span class="line"><span style="color:#24292E;">    )</span></span>
<span class="line"><span style="color:#24292E;">    $providerTypeFormData </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">Write-Variable</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># Note: The SentinelOne module is a Module script in Global </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">Import-Module</span><span style="color:#24292E;"> SentinelOne    </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">Get-Command</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">Module SentinelOne </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">Out-String</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">Write-Host</span></span>
<span class="line"><span style="color:#24292E;">    $S1AuthHeader </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">Connect-S1API</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">S1Uri $S1Uri </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">S1APIToken $S1ApiKey</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># The SentinelOne module in Global will automatically use the following $IntegrationContext values if present</span></span>
<span class="line"><span style="color:#24292E;">    $IntegrationContext.S1Uri </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> $S1Uri</span></span>
<span class="line"><span style="color:#24292E;">    $IntegrationContext.S1ApiKey </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> $S1ApiKey</span></span>
<span class="line"><span style="color:#24292E;">    $IntegrationContext.AuthHeader </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> $S1AuthHeader</span></span>
<span class="line"><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#24292E;">    [</span><span style="color:#D73A49;">OpResult</span><span style="color:#24292E;">]::Ok()</span></span>
<span class="line"><span style="color:#24292E;">} </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">HealthCheck {</span></span>
<span class="line"><span style="color:#24292E;">    [</span><span style="color:#005CC5;">CmdletBinding</span><span style="color:#24292E;">()]</span></span>
<span class="line"><span style="color:#24292E;">    [</span><span style="color:#005CC5;">OutputType</span><span style="color:#24292E;">([</span><span style="color:#D73A49;">HealthCheckResult</span><span style="color:#24292E;">])]</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">param</span><span style="color:#24292E;">(</span></span>
<span class="line"><span style="color:#24292E;">        </span></span>
<span class="line"><span style="color:#24292E;">    )</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># todo: implement health check</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">New-HealthyResult</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># ISupportsListingClients will create a Clients tab on the Integration for mapping ImmyBot tenants to the Clients returned by this script</span></span>
<span class="line"><span style="color:#24292E;">$Integration </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">Add-DynamicIntegrationCapability</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">Interface ISupportsListingClients </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">GetClients {</span></span>
<span class="line"><span style="color:#24292E;">    [</span><span style="color:#005CC5;">CmdletBinding</span><span style="color:#24292E;">()]</span></span>
<span class="line"><span style="color:#24292E;">    [</span><span style="color:#005CC5;">OutputType</span><span style="color:#24292E;">([</span><span style="color:#D73A49;">Immybot.Backend.Domain.Providers.IProviderClientDetails</span><span style="color:#24292E;">[]])]</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">param</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># return a list of clients for this integration using the New-IntegrationClient cmdlet</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">Import-Module</span><span style="color:#24292E;"> SentinelOne</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">Get-S1Site</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">Verbose </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ForEach-Object</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">New-IntegrationClient</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">ClientId </span><span style="color:#005CC5;">$_</span><span style="color:#24292E;">.Id </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">ClientName </span><span style="color:#005CC5;">$_</span><span style="color:#24292E;">.Name</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># supports listing agents</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">$Integration </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">Add-DynamicIntegrationCapability</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">Interface ISupportsListingAgents </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">GetAgents {</span></span>
<span class="line"><span style="color:#24292E;">    [</span><span style="color:#005CC5;">CmdletBinding</span><span style="color:#24292E;">()]</span></span>
<span class="line"><span style="color:#24292E;">    [</span><span style="color:#005CC5;">OutputType</span><span style="color:#24292E;">([</span><span style="color:#D73A49;">Immybot.Backend.Domain.Providers.IProviderAgentDetails</span><span style="color:#24292E;">[]])]</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">param</span><span style="color:#24292E;">(</span></span>
<span class="line"><span style="color:#24292E;">        [</span><span style="color:#005CC5;">Parameter</span><span style="color:#24292E;">()]</span></span>
<span class="line"><span style="color:#24292E;">        [</span><span style="color:#D73A49;">string</span><span style="color:#24292E;">[]]$ClientIds </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">$null</span></span>
<span class="line"><span style="color:#24292E;">    )</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># ClientIds will contain the clientids you mapped to ImmyBot tenants under the Integration-&gt;Clients tab</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># The agents you return here will go into the Computers-&gt;Pending Identification area until they are linked to Computers via the AgentId provided by ISupportsInventoryIdentification</span></span>
<span class="line"><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">Import-Module</span><span style="color:#24292E;"> SentinelOne</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">foreach</span><span style="color:#24292E;">($ClientId </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> $ClientIds)</span></span>
<span class="line"><span style="color:#24292E;">    {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">Get-S1Agent</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">SiteId $ClientId </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">Verbose </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ForEach-Object</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#005CC5;">New-IntegrationAgent</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">AgentId </span><span style="color:#005CC5;">$_</span><span style="color:#24292E;">.uuid </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">Name </span><span style="color:#005CC5;">$_</span><span style="color:#24292E;">.computerName </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">SerialNumber </span><span style="color:#005CC5;">$_</span><span style="color:#24292E;">.serialNumber </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">OSName </span><span style="color:#005CC5;">$_</span><span style="color:#24292E;">.osName </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">Manufacturer </span><span style="color:#005CC5;">$_</span><span style="color:#24292E;">.modelName </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">ClientId </span><span style="color:#005CC5;">$_</span><span style="color:#24292E;">.siteId </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">IsOnline </span><span style="color:#005CC5;">$true</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">AgentVersion </span><span style="color:#005CC5;">$_</span><span style="color:#24292E;">.agentVersion </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">SupportsRunningScripts </span><span style="color:#005CC5;">$false</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># supports inventory identification</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">$Integration </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">Add-DynamicIntegrationCapability</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">Interface ISupportsInventoryIdentification </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">GetInventoryScript {</span></span>
<span class="line"><span style="color:#24292E;">    [</span><span style="color:#005CC5;">CmdletBinding</span><span style="color:#24292E;">()]</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">param</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># This ScriptBlock will be run in the Metascript context for every machine during initial identification and daily inventory</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">Invoke-ImmyCommand</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;"># Return the SentinelOne AgentId</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;"># We will match it to New-IntegrationAgent -AgentId you returned in ISupportsListingAgents</span></span>
<span class="line"><span style="color:#24292E;">        $path </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">Resolve-Path</span><span style="color:#24292E;">  </span><span style="color:#032F62;">&quot;C:\\Program Files\\SentinelOne\\Sentinel Agent*\\SentinelCtl.exe&quot;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;">($path)</span></span>
<span class="line"><span style="color:#24292E;">        {</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">.</span><span style="color:#24292E;"> $path.Path agent_id</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># supports retrieving a tenant install token</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">$Integration </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">Add-DynamicIntegrationCapability</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">Interface ISupportsTenantInstallToken </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">GetTenantInstallToken {</span></span>
<span class="line"><span style="color:#24292E;">    [</span><span style="color:#005CC5;">CmdletBinding</span><span style="color:#24292E;">()]</span></span>
<span class="line"><span style="color:#24292E;">    [</span><span style="color:#005CC5;">OutputType</span><span style="color:#24292E;">([</span><span style="color:#D73A49;">System.String</span><span style="color:#24292E;">])]</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">param</span><span style="color:#24292E;">(</span></span>
<span class="line"><span style="color:#24292E;">        [</span><span style="color:#005CC5;">Parameter</span><span style="color:#24292E;">(</span><span style="color:#E36209;">Mandatory</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">$true</span><span style="color:#24292E;">)]</span></span>
<span class="line"><span style="color:#24292E;">        [</span><span style="color:#D73A49;">string</span><span style="color:#24292E;">]$clientId</span></span>
<span class="line"><span style="color:#24292E;">    )</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">Get-S1Site</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">Id $clientId </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">%</span><span style="color:#24292E;">{ </span><span style="color:#005CC5;">$_</span><span style="color:#24292E;">.registrationToken}</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># supports retrieving a tenant uninstall token</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">$Integration </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">Add-DynamicIntegrationCapability</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">Interface ISupportsTenantUninstallToken </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">GetTenantUninstallToken {</span></span>
<span class="line"><span style="color:#24292E;">    [</span><span style="color:#005CC5;">CmdletBinding</span><span style="color:#24292E;">()]</span></span>
<span class="line"><span style="color:#24292E;">    [</span><span style="color:#005CC5;">OutputType</span><span style="color:#24292E;">([</span><span style="color:#D73A49;">System.String</span><span style="color:#24292E;">])]</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">param</span><span style="color:#24292E;">(</span></span>
<span class="line"><span style="color:#24292E;">        [</span><span style="color:#005CC5;">Parameter</span><span style="color:#24292E;">(</span><span style="color:#E36209;">Mandatory</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">$true</span><span style="color:#24292E;">)]</span></span>
<span class="line"><span style="color:#24292E;">        [</span><span style="color:#D73A49;">System.String</span><span style="color:#24292E;">]$clientId</span></span>
<span class="line"><span style="color:#24292E;">    )</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;implement me&quot;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">$Integration </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">Add-DynamicIntegrationCapability</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">Interface ISupportsHttpRequest </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">HandleHttpRequest {</span></span>
<span class="line"><span style="color:#24292E;">    [</span><span style="color:#005CC5;">CmdletBinding</span><span style="color:#24292E;">()]</span></span>
<span class="line"><span style="color:#24292E;">    [</span><span style="color:#005CC5;">OutputType</span><span style="color:#24292E;">([</span><span style="color:#D73A49;">Microsoft.AspNetCore.Mvc.IActionResult</span><span style="color:#24292E;">])]</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">param</span><span style="color:#24292E;">(</span></span>
<span class="line"><span style="color:#24292E;">        [</span><span style="color:#005CC5;">Parameter</span><span style="color:#24292E;">(</span><span style="color:#E36209;">Mandatory</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">$True</span><span style="color:#24292E;">)]</span></span>
<span class="line"><span style="color:#24292E;">        [</span><span style="color:#D73A49;">Microsoft.AspNetCore.Http.HttpContext</span><span style="color:#24292E;">]$httpContext</span><span style="color:#D73A49;">,</span></span>
<span class="line"><span style="color:#24292E;">        [</span><span style="color:#005CC5;">Parameter</span><span style="color:#24292E;">(</span><span style="color:#E36209;">Mandatory</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">$false</span><span style="color:#24292E;">)]</span></span>
<span class="line"><span style="color:#24292E;">        $body</span><span style="color:#D73A49;">,</span></span>
<span class="line"><span style="color:#24292E;">        [</span><span style="color:#005CC5;">Parameter</span><span style="color:#24292E;">(</span><span style="color:#E36209;">Mandatory</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">$True</span><span style="color:#24292E;">)]</span></span>
<span class="line"><span style="color:#24292E;">        $route</span></span>
<span class="line"><span style="color:#24292E;">    )</span></span>
<span class="line"><span style="color:#24292E;">will response to  </span><span style="color:#032F62;">&quot;plugins/api/v1/{providerLinkId}&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># handle a http request sent to this integration</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># return an [ObjectResult] and set the status code</span></span>
<span class="line"><span style="color:#24292E;">    $res </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> [</span><span style="color:#D73A49;">ObjectResult</span><span style="color:#24292E;">]::new(</span><span style="color:#032F62;">&#39;ok&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    $res.StatusCode </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">200</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> $res;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"><span style="color:#D73A49;">return</span><span style="color:#24292E;"> $Integration</span></span></code></pre></div><h4 id="sentinelone-module" tabindex="-1">SentinelOne Module <a class="header-anchor" href="#sentinelone-module" aria-label="Permalink to &quot;SentinelOne Module&quot;">​</a></h4><div class="language-powershell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">powershell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">function</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Connect-S1API</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">    [</span><span style="color:#79B8FF;">CmdletBinding</span><span style="color:#E1E4E8;">()]</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">param</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#E1E4E8;">        [</span><span style="color:#79B8FF;">Parameter</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">Mandatory</span><span style="color:#E1E4E8;">)]</span></span>
<span class="line"><span style="color:#E1E4E8;">        [</span><span style="color:#F97583;">Uri</span><span style="color:#E1E4E8;">]$S1Uri</span><span style="color:#F97583;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        [</span><span style="color:#79B8FF;">Parameter</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">Mandatory</span><span style="color:#E1E4E8;">)]</span></span>
<span class="line"><span style="color:#E1E4E8;">        [</span><span style="color:#F97583;">string</span><span style="color:#E1E4E8;">]$S1APIToken</span></span>
<span class="line"><span style="color:#E1E4E8;">    )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    $S1AuthHeader </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">@</span><span style="color:#E1E4E8;">{ </span><span style="color:#9ECBFF;">&#39;Authorization&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;APIToken </span><span style="color:#E1E4E8;">$S1ApiToken</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;"> }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># if we have an integration context, then store it</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">$null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-ne</span><span style="color:#E1E4E8;"> $IntegrationContext) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        $IntegrationContext.AuthHeader </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> $S1AuthHeader</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    $</span><span style="color:#F97583;">script</span><span style="color:#E1E4E8;">:S1AuthHeader </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> $S1AuthHeader</span></span>
<span class="line"><span style="color:#E1E4E8;">    $</span><span style="color:#F97583;">script</span><span style="color:#E1E4E8;">:S1Uri </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> $S1Uri</span></span>
<span class="line"><span style="color:#E1E4E8;">    [</span><span style="color:#F97583;">Uri</span><span style="color:#E1E4E8;">]$</span><span style="color:#F97583;">script</span><span style="color:#E1E4E8;">:S1Uri </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> $S1Uri</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">        $SystemInfo </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">Invoke-S1RestMethod</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">Endpoint </span><span style="color:#9ECBFF;">&#39;system/info&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> ($SystemInfo.latestAgentVersion </span><span style="color:#F97583;">-like</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;*.*&quot;</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">Write-Progress</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;Authenticated to SentinelOne API and retrieved system/info. LatestAgentVersion: </span><span style="color:#F97583;">$</span><span style="color:#9ECBFF;">(</span><span style="color:#E1E4E8;">$SystemInfo.LatestAgentVersion</span><span style="color:#9ECBFF;">)</span><span style="color:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">            $</span><span style="color:#F97583;">script</span><span style="color:#E1E4E8;">:S1AuthHeader</span></span>
<span class="line"><span style="color:#E1E4E8;">        } </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">            $</span><span style="color:#F97583;">script</span><span style="color:#E1E4E8;">:S1AuthHeader </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">$null</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">throw</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;Invalid response from system/info API&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">Write-Verbose</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;SystemInfo:</span><span style="color:#79B8FF;">\`r\`n</span><span style="color:#F97583;">$</span><span style="color:#9ECBFF;">(</span><span style="color:#E1E4E8;">$SystemInfo</span><span style="color:#9ECBFF;"> </span><span style="color:#F97583;">|</span><span style="color:#9ECBFF;"> </span><span style="color:#79B8FF;">Format-List</span><span style="color:#9ECBFF;"> </span><span style="color:#F97583;">*</span><span style="color:#9ECBFF;"> </span><span style="color:#F97583;">|</span><span style="color:#9ECBFF;"> </span><span style="color:#79B8FF;">Out-String</span><span style="color:#9ECBFF;">)</span><span style="color:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">        $</span><span style="color:#F97583;">script</span><span style="color:#E1E4E8;">:S1AuthHeader </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">$null</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">throw</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">function</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Invoke-S1RestMethod</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">    [</span><span style="color:#79B8FF;">CmdletBinding</span><span style="color:#E1E4E8;">()]</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">param</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#E1E4E8;">        [</span><span style="color:#79B8FF;">Parameter</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">Mandatory</span><span style="color:#E1E4E8;">)]</span></span>
<span class="line"><span style="color:#E1E4E8;">        [</span><span style="color:#F97583;">string</span><span style="color:#E1E4E8;">]$Endpoint</span><span style="color:#F97583;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        [</span><span style="color:#F97583;">string</span><span style="color:#E1E4E8;">]$Method</span><span style="color:#F97583;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        [</span><span style="color:#F97583;">string</span><span style="color:#E1E4E8;">]$Body</span><span style="color:#F97583;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        [</span><span style="color:#F97583;">HashTable</span><span style="color:#E1E4E8;">]$QueryParameters </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">@</span><span style="color:#E1E4E8;">{}</span></span>
<span class="line"><span style="color:#E1E4E8;">    )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    $Endpoint </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> $Endpoint.TrimStart(</span><span style="color:#9ECBFF;">&#39;/&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    $params </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">@</span><span style="color:#E1E4E8;">{}</span></span>
<span class="line"><span style="color:#E1E4E8;">    $params.ContentType </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;application/json&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> ($Method) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        $params.method </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> $Method</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> ($Body) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        $params.body </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> $body</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">Write-Verbose</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;ThisBody:</span><span style="color:#79B8FF;">\`r\`n</span><span style="color:#F97583;">$</span><span style="color:#9ECBFF;">(</span><span style="color:#E1E4E8;">$params.Body</span><span style="color:#9ECBFF;">)</span><span style="color:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    $AuthHeader </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> $IntegrationContext.AuthHeader </span><span style="color:#F97583;">??</span><span style="color:#E1E4E8;"> $</span><span style="color:#F97583;">script</span><span style="color:#E1E4E8;">:S1AuthHeader</span></span>
<span class="line"><span style="color:#E1E4E8;">    $BaseUri </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> $IntegrationContext.S1Uri </span><span style="color:#F97583;">??</span><span style="color:#E1E4E8;"> $</span><span style="color:#F97583;">script</span><span style="color:#E1E4E8;">:S1Uri</span></span>
<span class="line"><span style="color:#E1E4E8;">    $Uri </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;</span><span style="color:#F97583;">$</span><span style="color:#9ECBFF;">(</span><span style="color:#E1E4E8;">$BaseUri</span><span style="color:#9ECBFF;">)</span><span style="color:#9ECBFF;">web/api/v2.1/</span><span style="color:#F97583;">$</span><span style="color:#9ECBFF;">(</span><span style="color:#E1E4E8;">$Endpoint</span><span style="color:#9ECBFF;">)</span><span style="color:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">do</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> ($QueryParameters) {</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#79B8FF;">Write-Verbose</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;QueryParameters: </span><span style="color:#F97583;">$</span><span style="color:#9ECBFF;">(</span><span style="color:#E1E4E8;">$QueryParameters</span><span style="color:#9ECBFF;"> </span><span style="color:#F97583;">|</span><span style="color:#9ECBFF;"> </span><span style="color:#79B8FF;">Out-String</span><span style="color:#9ECBFF;">)</span><span style="color:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">                $UriWithQuery </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">Add-UriQueryParameter</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">Uri $Uri </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">Parameter $QueryParameters</span></span>
<span class="line"><span style="color:#E1E4E8;">                $UriWithQuery </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> $UriWithQuery.ToString().Replace(</span><span style="color:#9ECBFF;">&quot;+&quot;</span><span style="color:#F97583;">,</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;%20&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">            }</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">Write-Verbose</span><span style="color:#E1E4E8;"> $UriWithQuery</span></span>
<span class="line"><span style="color:#E1E4E8;">            $Results </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">$null</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">Invoke-RestMethod</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">Uri $UriWithQuery </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">Headers $AuthHeader @params </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">ErrorAction Stop </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">Tee-Object</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">Variable Results </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">Select-Object</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">Expand </span><span style="color:#F97583;">data</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">            $Results </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">Format-List</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">Out-String</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">Write-Verbose</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> ($Results.pagination </span><span style="color:#F97583;">-and</span><span style="color:#E1E4E8;"> $Results.pagination.nextcursor) {</span></span>
<span class="line"><span style="color:#E1E4E8;">                $QueryParameters.cursor </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> $Results.pagination.nextcursor</span></span>
<span class="line"><span style="color:#E1E4E8;">            }</span></span>
<span class="line"><span style="color:#E1E4E8;">        } </span><span style="color:#F97583;">while</span><span style="color:#E1E4E8;"> ($Results.pagination </span><span style="color:#F97583;">-and</span><span style="color:#E1E4E8;"> $Results.pagination.nextcursor)</span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#79B8FF;">$_</span><span style="color:#E1E4E8;">.Exception.Response.StatusCode </span><span style="color:#F97583;">-eq</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;Unauthorized&quot;</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">Write-Error</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;Unauthorized when accessing </span><span style="color:#E1E4E8;">$Endpoint</span><span style="color:#9ECBFF;">, please ensure the user associated with the API Key can access this endpoint.&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">Write-Error</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">Exception </span><span style="color:#79B8FF;">$_</span><span style="color:#E1E4E8;">.Exception </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">ErrorAction Stop</span></span>
<span class="line"><span style="color:#E1E4E8;">        } </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">throw</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">$_</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">#.Exception.Response</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">function</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Get-S1Site</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">    [</span><span style="color:#79B8FF;">CmdletBinding</span><span style="color:#E1E4E8;">()]</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">param</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#E1E4E8;">        [</span><span style="color:#F97583;">string</span><span style="color:#E1E4E8;">]$Name</span><span style="color:#F97583;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        [</span><span style="color:#F97583;">string</span><span style="color:#E1E4E8;">]$Id</span></span>
<span class="line"><span style="color:#E1E4E8;">    )</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#E1E4E8;">    $Endpoint </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;sites&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> ($Id) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        $Endpoint </span><span style="color:#F97583;">+=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;/</span><span style="color:#E1E4E8;">$id</span><span style="color:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">Invoke-S1RestMethod</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">Endpoint $Endpoint</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">return</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    $QueryParameters </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">@</span><span style="color:#E1E4E8;">{}</span></span>
<span class="line"><span style="color:#E1E4E8;">    $LimitParameter </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">@</span><span style="color:#E1E4E8;">{ limit </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">100</span><span style="color:#E1E4E8;"> }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> ($Name) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        $QueryParameters[</span><span style="color:#9ECBFF;">&#39;name&#39;</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> $Name</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    $CombinedParameters </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> $QueryParameters </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> $LimitParameter</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">-not</span><span style="color:#E1E4E8;"> $Name) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">Invoke-S1RestMethod</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">Endpoint $Endpoint </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">QueryParameters $LimitParameter </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">Select-Object</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">Expand sites </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">Sort-Object</span><span style="color:#E1E4E8;"> name</span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">        $Sites </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">Invoke-S1RestMethod</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">Endpoint $Endpoint </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">QueryParameters $CombinedParameters </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">Select-Object</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">Expand sites</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">-not</span><span style="color:#E1E4E8;"> $Sites) {</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">Write-Progress</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;No sites matched name: </span><span style="color:#E1E4E8;">$Name</span><span style="color:#9ECBFF;"> using API filter. Fetching all sites...&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">            $Sites </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">Invoke-S1RestMethod</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">Endpoint $Endpoint </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">QueryParameters $LimitParameter </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">Select-Object</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">Expand sites </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">Sort-Object</span><span style="color:#E1E4E8;"> name</span></span>
<span class="line"><span style="color:#E1E4E8;">            $SiteCount </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> $Sites </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">Measure-Object</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">Select-Object</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">expand Count</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">Write-Progress</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;Found </span><span style="color:#E1E4E8;">$SiteCount</span><span style="color:#9ECBFF;"> site(s)&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">        $Sites </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">Select-Object</span><span style="color:#E1E4E8;"> id</span><span style="color:#F97583;">,</span><span style="color:#E1E4E8;"> name</span><span style="color:#F97583;">,</span><span style="color:#E1E4E8;"> isDefault</span><span style="color:#F97583;">,</span><span style="color:#E1E4E8;"> registrationToken </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">Out-String</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">Write-Verbose</span></span>
<span class="line"><span style="color:#E1E4E8;">        $Site </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> $Sites </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">Where-Object</span><span style="color:#E1E4E8;"> { </span><span style="color:#79B8FF;">$_</span><span style="color:#E1E4E8;">.name.Trim() </span><span style="color:#F97583;">-like</span><span style="color:#E1E4E8;"> $Name } </span><span style="color:#6A737D;"># Potential edge case where the \`name\` property includes whitespace</span></span>
<span class="line"><span style="color:#E1E4E8;">        $Site </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> $Site </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> Should</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">HaveOne </span><span style="color:#9ECBFF;">&quot;SentinelOne Site matching </span><span style="color:#E1E4E8;">$Name</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">TakeFirst</span></span>
<span class="line"><span style="color:#E1E4E8;">        $Site</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">function</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Get-S1Agent</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">    [</span><span style="color:#79B8FF;">CmdletBinding</span><span style="color:#E1E4E8;">()]</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">param</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#E1E4E8;">        [</span><span style="color:#F97583;">string</span><span style="color:#E1E4E8;">]$Name</span></span>
<span class="line"><span style="color:#E1E4E8;">    )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    $Endpoint </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;agents&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#E1E4E8;">    $QueryParameters </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">@</span><span style="color:#E1E4E8;">{}</span></span>
<span class="line"><span style="color:#E1E4E8;">    $LimitParameter </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">@</span><span style="color:#E1E4E8;">{ limit </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">100</span><span style="color:#E1E4E8;"> }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> ($Name) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        $QueryParameters[</span><span style="color:#9ECBFF;">&#39;name&#39;</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> $Name</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    $CombinedParameters </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> $QueryParameters </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> $LimitParameter</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">-not</span><span style="color:#E1E4E8;"> $Name) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">Invoke-S1RestMethod</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">Endpoint $Endpoint </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">QueryParameters $LimitParameter </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">Sort-Object</span><span style="color:#E1E4E8;"> computerName             </span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">        $QueryParameters.name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> $Name</span></span>
<span class="line"><span style="color:#E1E4E8;">        $Agents </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">Invoke-S1RestMethod</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">Endpoint $Endpoint </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">QueryParameters $CombinedParameters</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">-not</span><span style="color:#E1E4E8;"> $Agents) {</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">Write-Progress</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;No Agents matched name: </span><span style="color:#E1E4E8;">$Name</span><span style="color:#9ECBFF;"> using API filter. Fetching all Agents...&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">            $Agents </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">Get-S1Site</span></span>
<span class="line"><span style="color:#E1E4E8;">            $AgentCount </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> $Agents </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">Measure-Object</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">Select-Object</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">expand Count</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">Write-Progress</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;Found </span><span style="color:#E1E4E8;">$AgentCount</span><span style="color:#9ECBFF;"> agent(s)&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">        $Agents </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">Select-Object</span><span style="color:#E1E4E8;"> id</span><span style="color:#F97583;">,</span><span style="color:#E1E4E8;"> name</span><span style="color:#F97583;">,</span><span style="color:#E1E4E8;"> isDefault</span><span style="color:#F97583;">,</span><span style="color:#E1E4E8;"> registrationToken </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">Out-String</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">Write-Verbose</span></span>
<span class="line"><span style="color:#E1E4E8;">        $Agent </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> $Agent </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">Where-Object</span><span style="color:#E1E4E8;"> { </span><span style="color:#79B8FF;">$_</span><span style="color:#E1E4E8;">.name.Trim() </span><span style="color:#F97583;">-like</span><span style="color:#E1E4E8;"> $Name } </span><span style="color:#6A737D;"># Potential edge case where the \`name\` property includes whitespace</span></span>
<span class="line"><span style="color:#E1E4E8;">        $Agent </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> $Agent </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> Should</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">HaveOne </span><span style="color:#9ECBFF;">&quot;SentinelOne Agent matching </span><span style="color:#E1E4E8;">$Name</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">TakeFirst</span></span>
<span class="line"><span style="color:#E1E4E8;">        $Agent</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#79B8FF;">Export-ModuleMember</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">Function </span><span style="color:#F97583;">@</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">&#39;Connect-S1API&#39;</span><span style="color:#F97583;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">&#39;Invoke-S1RestMethod&#39;</span><span style="color:#F97583;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">&#39;Get-S1Site&#39;</span><span style="color:#F97583;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">&#39;Get-S1Agent&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">function</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Connect-S1API</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    [</span><span style="color:#005CC5;">CmdletBinding</span><span style="color:#24292E;">()]</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">param</span><span style="color:#24292E;">(</span></span>
<span class="line"><span style="color:#24292E;">        [</span><span style="color:#005CC5;">Parameter</span><span style="color:#24292E;">(</span><span style="color:#E36209;">Mandatory</span><span style="color:#24292E;">)]</span></span>
<span class="line"><span style="color:#24292E;">        [</span><span style="color:#D73A49;">Uri</span><span style="color:#24292E;">]$S1Uri</span><span style="color:#D73A49;">,</span></span>
<span class="line"><span style="color:#24292E;">        [</span><span style="color:#005CC5;">Parameter</span><span style="color:#24292E;">(</span><span style="color:#E36209;">Mandatory</span><span style="color:#24292E;">)]</span></span>
<span class="line"><span style="color:#24292E;">        [</span><span style="color:#D73A49;">string</span><span style="color:#24292E;">]$S1APIToken</span></span>
<span class="line"><span style="color:#24292E;">    )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    $S1AuthHeader </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">@</span><span style="color:#24292E;">{ </span><span style="color:#032F62;">&#39;Authorization&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;APIToken </span><span style="color:#24292E;">$S1ApiToken</span><span style="color:#032F62;">&quot;</span><span style="color:#24292E;"> }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># if we have an integration context, then store it</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#005CC5;">$null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-ne</span><span style="color:#24292E;"> $IntegrationContext) {</span></span>
<span class="line"><span style="color:#24292E;">        $IntegrationContext.AuthHeader </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> $S1AuthHeader</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    $</span><span style="color:#D73A49;">script</span><span style="color:#24292E;">:S1AuthHeader </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> $S1AuthHeader</span></span>
<span class="line"><span style="color:#24292E;">    $</span><span style="color:#D73A49;">script</span><span style="color:#24292E;">:S1Uri </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> $S1Uri</span></span>
<span class="line"><span style="color:#24292E;">    [</span><span style="color:#D73A49;">Uri</span><span style="color:#24292E;">]$</span><span style="color:#D73A49;">script</span><span style="color:#24292E;">:S1Uri </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> $S1Uri</span></span>
<span class="line"><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">try</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">        $SystemInfo </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">Invoke-S1RestMethod</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">Endpoint </span><span style="color:#032F62;">&#39;system/info&#39;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> ($SystemInfo.latestAgentVersion </span><span style="color:#D73A49;">-like</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;*.*&quot;</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#005CC5;">Write-Progress</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;Authenticated to SentinelOne API and retrieved system/info. LatestAgentVersion: </span><span style="color:#D73A49;">$</span><span style="color:#032F62;">(</span><span style="color:#24292E;">$SystemInfo.LatestAgentVersion</span><span style="color:#032F62;">)</span><span style="color:#032F62;">&quot;</span></span>
<span class="line"><span style="color:#24292E;">            $</span><span style="color:#D73A49;">script</span><span style="color:#24292E;">:S1AuthHeader</span></span>
<span class="line"><span style="color:#24292E;">        } </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">            $</span><span style="color:#D73A49;">script</span><span style="color:#24292E;">:S1AuthHeader </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">$null</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">throw</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;Invalid response from system/info API&quot;</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">Write-Verbose</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;SystemInfo:</span><span style="color:#005CC5;">\`r\`n</span><span style="color:#D73A49;">$</span><span style="color:#032F62;">(</span><span style="color:#24292E;">$SystemInfo</span><span style="color:#032F62;"> </span><span style="color:#D73A49;">|</span><span style="color:#032F62;"> </span><span style="color:#005CC5;">Format-List</span><span style="color:#032F62;"> </span><span style="color:#D73A49;">*</span><span style="color:#032F62;"> </span><span style="color:#D73A49;">|</span><span style="color:#032F62;"> </span><span style="color:#005CC5;">Out-String</span><span style="color:#032F62;">)</span><span style="color:#032F62;">&quot;</span></span>
<span class="line"><span style="color:#24292E;">    } </span><span style="color:#D73A49;">catch</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">        $</span><span style="color:#D73A49;">script</span><span style="color:#24292E;">:S1AuthHeader </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">$null</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">throw</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">function</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Invoke-S1RestMethod</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    [</span><span style="color:#005CC5;">CmdletBinding</span><span style="color:#24292E;">()]</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">param</span><span style="color:#24292E;">(</span></span>
<span class="line"><span style="color:#24292E;">        [</span><span style="color:#005CC5;">Parameter</span><span style="color:#24292E;">(</span><span style="color:#E36209;">Mandatory</span><span style="color:#24292E;">)]</span></span>
<span class="line"><span style="color:#24292E;">        [</span><span style="color:#D73A49;">string</span><span style="color:#24292E;">]$Endpoint</span><span style="color:#D73A49;">,</span></span>
<span class="line"><span style="color:#24292E;">        [</span><span style="color:#D73A49;">string</span><span style="color:#24292E;">]$Method</span><span style="color:#D73A49;">,</span></span>
<span class="line"><span style="color:#24292E;">        [</span><span style="color:#D73A49;">string</span><span style="color:#24292E;">]$Body</span><span style="color:#D73A49;">,</span></span>
<span class="line"><span style="color:#24292E;">        [</span><span style="color:#D73A49;">HashTable</span><span style="color:#24292E;">]$QueryParameters </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">@</span><span style="color:#24292E;">{}</span></span>
<span class="line"><span style="color:#24292E;">    )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    $Endpoint </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> $Endpoint.TrimStart(</span><span style="color:#032F62;">&#39;/&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    $params </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">@</span><span style="color:#24292E;">{}</span></span>
<span class="line"><span style="color:#24292E;">    $params.ContentType </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;application/json&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> ($Method) {</span></span>
<span class="line"><span style="color:#24292E;">        $params.method </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> $Method</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> ($Body) {</span></span>
<span class="line"><span style="color:#24292E;">        $params.body </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> $body</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">Write-Verbose</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;ThisBody:</span><span style="color:#005CC5;">\`r\`n</span><span style="color:#D73A49;">$</span><span style="color:#032F62;">(</span><span style="color:#24292E;">$params.Body</span><span style="color:#032F62;">)</span><span style="color:#032F62;">&quot;</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    $AuthHeader </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> $IntegrationContext.AuthHeader </span><span style="color:#D73A49;">??</span><span style="color:#24292E;"> $</span><span style="color:#D73A49;">script</span><span style="color:#24292E;">:S1AuthHeader</span></span>
<span class="line"><span style="color:#24292E;">    $BaseUri </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> $IntegrationContext.S1Uri </span><span style="color:#D73A49;">??</span><span style="color:#24292E;"> $</span><span style="color:#D73A49;">script</span><span style="color:#24292E;">:S1Uri</span></span>
<span class="line"><span style="color:#24292E;">    $Uri </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;</span><span style="color:#D73A49;">$</span><span style="color:#032F62;">(</span><span style="color:#24292E;">$BaseUri</span><span style="color:#032F62;">)</span><span style="color:#032F62;">web/api/v2.1/</span><span style="color:#D73A49;">$</span><span style="color:#032F62;">(</span><span style="color:#24292E;">$Endpoint</span><span style="color:#032F62;">)</span><span style="color:#032F62;">&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">try</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">do</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> ($QueryParameters) {</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#005CC5;">Write-Verbose</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;QueryParameters: </span><span style="color:#D73A49;">$</span><span style="color:#032F62;">(</span><span style="color:#24292E;">$QueryParameters</span><span style="color:#032F62;"> </span><span style="color:#D73A49;">|</span><span style="color:#032F62;"> </span><span style="color:#005CC5;">Out-String</span><span style="color:#032F62;">)</span><span style="color:#032F62;">&quot;</span></span>
<span class="line"><span style="color:#24292E;">                $UriWithQuery </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">Add-UriQueryParameter</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">Uri $Uri </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">Parameter $QueryParameters</span></span>
<span class="line"><span style="color:#24292E;">                $UriWithQuery </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> $UriWithQuery.ToString().Replace(</span><span style="color:#032F62;">&quot;+&quot;</span><span style="color:#D73A49;">,</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;%20&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">            }</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#005CC5;">Write-Verbose</span><span style="color:#24292E;"> $UriWithQuery</span></span>
<span class="line"><span style="color:#24292E;">            $Results </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">$null</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#005CC5;">Invoke-RestMethod</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">Uri $UriWithQuery </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">Headers $AuthHeader @params </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">ErrorAction Stop </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">Tee-Object</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">Variable Results </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">Select-Object</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">Expand </span><span style="color:#D73A49;">data</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">            $Results </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">Format-List</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">Out-String</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">Write-Verbose</span></span>
<span class="line"><span style="color:#24292E;">            </span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> ($Results.pagination </span><span style="color:#D73A49;">-and</span><span style="color:#24292E;"> $Results.pagination.nextcursor) {</span></span>
<span class="line"><span style="color:#24292E;">                $QueryParameters.cursor </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> $Results.pagination.nextcursor</span></span>
<span class="line"><span style="color:#24292E;">            }</span></span>
<span class="line"><span style="color:#24292E;">        } </span><span style="color:#D73A49;">while</span><span style="color:#24292E;"> ($Results.pagination </span><span style="color:#D73A49;">-and</span><span style="color:#24292E;"> $Results.pagination.nextcursor)</span></span>
<span class="line"><span style="color:#24292E;">    } </span><span style="color:#D73A49;">catch</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#005CC5;">$_</span><span style="color:#24292E;">.Exception.Response.StatusCode </span><span style="color:#D73A49;">-eq</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;Unauthorized&quot;</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#005CC5;">Write-Error</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;Unauthorized when accessing </span><span style="color:#24292E;">$Endpoint</span><span style="color:#032F62;">, please ensure the user associated with the API Key can access this endpoint.&quot;</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#005CC5;">Write-Error</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">Exception </span><span style="color:#005CC5;">$_</span><span style="color:#24292E;">.Exception </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">ErrorAction Stop</span></span>
<span class="line"><span style="color:#24292E;">        } </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">throw</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">$_</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">#.Exception.Response</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">function</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Get-S1Site</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    [</span><span style="color:#005CC5;">CmdletBinding</span><span style="color:#24292E;">()]</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">param</span><span style="color:#24292E;">(</span></span>
<span class="line"><span style="color:#24292E;">        [</span><span style="color:#D73A49;">string</span><span style="color:#24292E;">]$Name</span><span style="color:#D73A49;">,</span></span>
<span class="line"><span style="color:#24292E;">        [</span><span style="color:#D73A49;">string</span><span style="color:#24292E;">]$Id</span></span>
<span class="line"><span style="color:#24292E;">    )</span></span>
<span class="line"><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#24292E;">    $Endpoint </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;sites&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> ($Id) {</span></span>
<span class="line"><span style="color:#24292E;">        $Endpoint </span><span style="color:#D73A49;">+=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;/</span><span style="color:#24292E;">$id</span><span style="color:#032F62;">&quot;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">Invoke-S1RestMethod</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">Endpoint $Endpoint</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    $QueryParameters </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">@</span><span style="color:#24292E;">{}</span></span>
<span class="line"><span style="color:#24292E;">    $LimitParameter </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">@</span><span style="color:#24292E;">{ limit </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">100</span><span style="color:#24292E;"> }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> ($Name) {</span></span>
<span class="line"><span style="color:#24292E;">        $QueryParameters[</span><span style="color:#032F62;">&#39;name&#39;</span><span style="color:#24292E;">] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> $Name</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    $CombinedParameters </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> $QueryParameters </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> $LimitParameter</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">-not</span><span style="color:#24292E;"> $Name) {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">Invoke-S1RestMethod</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">Endpoint $Endpoint </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">QueryParameters $LimitParameter </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">Select-Object</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">Expand sites </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">Sort-Object</span><span style="color:#24292E;"> name</span></span>
<span class="line"><span style="color:#24292E;">    } </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">        $Sites </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">Invoke-S1RestMethod</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">Endpoint $Endpoint </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">QueryParameters $CombinedParameters </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">Select-Object</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">Expand sites</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">-not</span><span style="color:#24292E;"> $Sites) {</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#005CC5;">Write-Progress</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;No sites matched name: </span><span style="color:#24292E;">$Name</span><span style="color:#032F62;"> using API filter. Fetching all sites...&quot;</span></span>
<span class="line"><span style="color:#24292E;">            $Sites </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">Invoke-S1RestMethod</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">Endpoint $Endpoint </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">QueryParameters $LimitParameter </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">Select-Object</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">Expand sites </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">Sort-Object</span><span style="color:#24292E;"> name</span></span>
<span class="line"><span style="color:#24292E;">            $SiteCount </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> $Sites </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">Measure-Object</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">Select-Object</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">expand Count</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#005CC5;">Write-Progress</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;Found </span><span style="color:#24292E;">$SiteCount</span><span style="color:#032F62;"> site(s)&quot;</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">        $Sites </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">Select-Object</span><span style="color:#24292E;"> id</span><span style="color:#D73A49;">,</span><span style="color:#24292E;"> name</span><span style="color:#D73A49;">,</span><span style="color:#24292E;"> isDefault</span><span style="color:#D73A49;">,</span><span style="color:#24292E;"> registrationToken </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">Out-String</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">Write-Verbose</span></span>
<span class="line"><span style="color:#24292E;">        $Site </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> $Sites </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">Where-Object</span><span style="color:#24292E;"> { </span><span style="color:#005CC5;">$_</span><span style="color:#24292E;">.name.Trim() </span><span style="color:#D73A49;">-like</span><span style="color:#24292E;"> $Name } </span><span style="color:#6A737D;"># Potential edge case where the \`name\` property includes whitespace</span></span>
<span class="line"><span style="color:#24292E;">        $Site </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> $Site </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> Should</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">HaveOne </span><span style="color:#032F62;">&quot;SentinelOne Site matching </span><span style="color:#24292E;">$Name</span><span style="color:#032F62;">&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">TakeFirst</span></span>
<span class="line"><span style="color:#24292E;">        $Site</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">function</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Get-S1Agent</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    [</span><span style="color:#005CC5;">CmdletBinding</span><span style="color:#24292E;">()]</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">param</span><span style="color:#24292E;">(</span></span>
<span class="line"><span style="color:#24292E;">        [</span><span style="color:#D73A49;">string</span><span style="color:#24292E;">]$Name</span></span>
<span class="line"><span style="color:#24292E;">    )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    $Endpoint </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;agents&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#24292E;">    $QueryParameters </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">@</span><span style="color:#24292E;">{}</span></span>
<span class="line"><span style="color:#24292E;">    $LimitParameter </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">@</span><span style="color:#24292E;">{ limit </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">100</span><span style="color:#24292E;"> }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> ($Name) {</span></span>
<span class="line"><span style="color:#24292E;">        $QueryParameters[</span><span style="color:#032F62;">&#39;name&#39;</span><span style="color:#24292E;">] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> $Name</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    $CombinedParameters </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> $QueryParameters </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> $LimitParameter</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">-not</span><span style="color:#24292E;"> $Name) {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">Invoke-S1RestMethod</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">Endpoint $Endpoint </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">QueryParameters $LimitParameter </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">Sort-Object</span><span style="color:#24292E;"> computerName             </span></span>
<span class="line"><span style="color:#24292E;">    } </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">        $QueryParameters.name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> $Name</span></span>
<span class="line"><span style="color:#24292E;">        $Agents </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">Invoke-S1RestMethod</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">Endpoint $Endpoint </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">QueryParameters $CombinedParameters</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">-not</span><span style="color:#24292E;"> $Agents) {</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#005CC5;">Write-Progress</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;No Agents matched name: </span><span style="color:#24292E;">$Name</span><span style="color:#032F62;"> using API filter. Fetching all Agents...&quot;</span></span>
<span class="line"><span style="color:#24292E;">            $Agents </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">Get-S1Site</span></span>
<span class="line"><span style="color:#24292E;">            $AgentCount </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> $Agents </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">Measure-Object</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">Select-Object</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">expand Count</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#005CC5;">Write-Progress</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;Found </span><span style="color:#24292E;">$AgentCount</span><span style="color:#032F62;"> agent(s)&quot;</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">        $Agents </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">Select-Object</span><span style="color:#24292E;"> id</span><span style="color:#D73A49;">,</span><span style="color:#24292E;"> name</span><span style="color:#D73A49;">,</span><span style="color:#24292E;"> isDefault</span><span style="color:#D73A49;">,</span><span style="color:#24292E;"> registrationToken </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">Out-String</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">Write-Verbose</span></span>
<span class="line"><span style="color:#24292E;">        $Agent </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> $Agent </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">Where-Object</span><span style="color:#24292E;"> { </span><span style="color:#005CC5;">$_</span><span style="color:#24292E;">.name.Trim() </span><span style="color:#D73A49;">-like</span><span style="color:#24292E;"> $Name } </span><span style="color:#6A737D;"># Potential edge case where the \`name\` property includes whitespace</span></span>
<span class="line"><span style="color:#24292E;">        $Agent </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> $Agent </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> Should</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">HaveOne </span><span style="color:#032F62;">&quot;SentinelOne Agent matching </span><span style="color:#24292E;">$Name</span><span style="color:#032F62;">&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">TakeFirst</span></span>
<span class="line"><span style="color:#24292E;">        $Agent</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#005CC5;">Export-ModuleMember</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">Function </span><span style="color:#D73A49;">@</span><span style="color:#24292E;">(</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">&#39;Connect-S1API&#39;</span><span style="color:#D73A49;">,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">&#39;Invoke-S1RestMethod&#39;</span><span style="color:#D73A49;">,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">&#39;Get-S1Site&#39;</span><span style="color:#D73A49;">,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">&#39;Get-S1Agent&#39;</span></span>
<span class="line"><span style="color:#24292E;">)</span></span></code></pre></div><h5 id="example-respond-to-webhook-with-isupportshttprequest" tabindex="-1">Example - Respond to webhook with ISupportsHttpRequest <a class="header-anchor" href="#example-respond-to-webhook-with-isupportshttprequest" aria-label="Permalink to &quot;Example - Respond to webhook with ISupportsHttpRequest&quot;">​</a></h5><div class="language-powershell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">powershell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">$Integration </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">New-DynamicIntegration</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">Init {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">param</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">    [</span><span style="color:#F97583;">OpResult</span><span style="color:#E1E4E8;">]::Ok()</span></span>
<span class="line"><span style="color:#E1E4E8;">} </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">HealthCheck {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">New-HealthyResult</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">} </span></span>
<span class="line"><span style="color:#E1E4E8;">$Integration </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">Add-DynamicIntegrationCapability</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">Interface ISupportsHttpRequest </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">HandleHttpRequest {</span></span>
<span class="line"><span style="color:#E1E4E8;">    [</span><span style="color:#79B8FF;">CmdletBinding</span><span style="color:#E1E4E8;">()]</span></span>
<span class="line"><span style="color:#E1E4E8;">    [</span><span style="color:#79B8FF;">OutputType</span><span style="color:#E1E4E8;">([</span><span style="color:#F97583;">Microsoft.AspNetCore.Mvc.IActionResult</span><span style="color:#E1E4E8;">])]</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">param</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#E1E4E8;">        [</span><span style="color:#79B8FF;">Parameter</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">Mandatory</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">$True</span><span style="color:#E1E4E8;">)]</span></span>
<span class="line"><span style="color:#E1E4E8;">        [</span><span style="color:#F97583;">Microsoft.AspNetCore.Http.HttpContext</span><span style="color:#E1E4E8;">]$httpContext</span><span style="color:#F97583;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        [</span><span style="color:#79B8FF;">Parameter</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">Mandatory</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">$false</span><span style="color:#E1E4E8;">)]</span></span>
<span class="line"><span style="color:#E1E4E8;">        $body</span><span style="color:#F97583;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">        [</span><span style="color:#79B8FF;">Parameter</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">Mandatory</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">$True</span><span style="color:#E1E4E8;">)]</span></span>
<span class="line"><span style="color:#E1E4E8;">        $route</span></span>
<span class="line"><span style="color:#E1E4E8;">    )</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># handle a http request sent to this integration</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># return an [ObjectResult] and set the status code</span></span>
<span class="line"><span style="color:#E1E4E8;">    $res </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> [</span><span style="color:#F97583;">ObjectResult</span><span style="color:#E1E4E8;">]::new(</span><span style="color:#9ECBFF;">&#39;ok&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    $res.StatusCode </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">200</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> $res;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">$Integration</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">$Integration </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">New-DynamicIntegration</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">Init {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">param</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;">    [</span><span style="color:#D73A49;">OpResult</span><span style="color:#24292E;">]::Ok()</span></span>
<span class="line"><span style="color:#24292E;">} </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">HealthCheck {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">New-HealthyResult</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">} </span></span>
<span class="line"><span style="color:#24292E;">$Integration </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">Add-DynamicIntegrationCapability</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">Interface ISupportsHttpRequest </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">HandleHttpRequest {</span></span>
<span class="line"><span style="color:#24292E;">    [</span><span style="color:#005CC5;">CmdletBinding</span><span style="color:#24292E;">()]</span></span>
<span class="line"><span style="color:#24292E;">    [</span><span style="color:#005CC5;">OutputType</span><span style="color:#24292E;">([</span><span style="color:#D73A49;">Microsoft.AspNetCore.Mvc.IActionResult</span><span style="color:#24292E;">])]</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">param</span><span style="color:#24292E;">(</span></span>
<span class="line"><span style="color:#24292E;">        [</span><span style="color:#005CC5;">Parameter</span><span style="color:#24292E;">(</span><span style="color:#E36209;">Mandatory</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">$True</span><span style="color:#24292E;">)]</span></span>
<span class="line"><span style="color:#24292E;">        [</span><span style="color:#D73A49;">Microsoft.AspNetCore.Http.HttpContext</span><span style="color:#24292E;">]$httpContext</span><span style="color:#D73A49;">,</span></span>
<span class="line"><span style="color:#24292E;">        [</span><span style="color:#005CC5;">Parameter</span><span style="color:#24292E;">(</span><span style="color:#E36209;">Mandatory</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">$false</span><span style="color:#24292E;">)]</span></span>
<span class="line"><span style="color:#24292E;">        $body</span><span style="color:#D73A49;">,</span></span>
<span class="line"><span style="color:#24292E;">        [</span><span style="color:#005CC5;">Parameter</span><span style="color:#24292E;">(</span><span style="color:#E36209;">Mandatory</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">$True</span><span style="color:#24292E;">)]</span></span>
<span class="line"><span style="color:#24292E;">        $route</span></span>
<span class="line"><span style="color:#24292E;">    )</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># handle a http request sent to this integration</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># return an [ObjectResult] and set the status code</span></span>
<span class="line"><span style="color:#24292E;">    $res </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> [</span><span style="color:#D73A49;">ObjectResult</span><span style="color:#24292E;">]::new(</span><span style="color:#032F62;">&#39;ok&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    $res.StatusCode </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">200</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> $res;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">$Integration</span></span></code></pre></div><img width="688" alt="image" src="https://github.com/immense/immybot-documentation/assets/1424395/6bf7dd8b-3700-4414-aa57-ad6d8151245f">`,53),e=[o];function t(r,c,E,y,i,F){return n(),a("div",null,e)}const C=s(p,[["render",t]]);export{u as __pageData,C as default};
